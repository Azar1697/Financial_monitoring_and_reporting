<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–î–∞—à–±–æ—Ä–¥ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ---- –±–∞–∑–æ–≤–∞—è –≤—ë—Ä—Å—Ç–∫–∞ ---- */
    body{font-family:Arial,Helvetica,sans-serif;background:#f5f7fa;margin:0;padding:20px}
    .container{max-width:1200px;margin:auto}
    h1{margin:0 0 20px;text-align:center}

    /* ---- –≤–µ—Ä—Ö–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è ---- */
    .top-nav{display:flex;justify-content:center;margin-bottom:18px}
    .btn{cursor:pointer;border:none;border-radius:4px;padding:8px 16px;font-weight:bold;color:#fff}
    .home-btn{background:#17a2b8}        /* –±–∏—Ä—é–∑–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ ¬´–¥–æ–º–æ–π¬ª */

    /* ---- —Ñ–∏–ª—å—Ç—Ä—ã ---- */
    .filter-panel{background:#fff;padding:15px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.08);margin-bottom:30px}
    .filter-fields{display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between}
    .filter-fields label{display:flex;flex-direction:column;flex:1 1 150px;font-size:14px}
    .filter-fields input,.filter-fields select{margin-top:4px;padding:6px;border:1px solid #ccc;border-radius:4px}
    .filter-buttons{display:flex;gap:12px;justify-content:center;margin-top:10px}
    .apply-btn{background:#007bff}
    .clear-btn{background:#6c757d}
    .report-btn{background:#28a745}

    /* ---- –≥—Ä–∞—Ñ–∏–∫–∏ ---- */
    .charts{display:flex;flex-wrap:wrap;gap:30px;justify-content:center}
    .chart-container{width:350px;height:350px;background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.08);display:flex;flex-direction:column}
    .chart-container h3{margin:0 0 6px;text-align:center;font-size:16px}
    .chart-container canvas{flex:1 1 auto}

    /* ---- –º–æ–¥–∞–ª–∫–∞ ---- */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:1000}
    .modal.active{display:flex}
    .modal-box{background:#fff;padding:24px 28px;border-radius:8px;width:320px;box-shadow:0 4px 12px rgba(0,0,0,.15);display:flex;flex-direction:column;gap:12px}
    .modal-box h2{margin:0 0 6px;font-size:18px;text-align:center}
    .modal-box label{font-size:14px;display:flex;flex-direction:column;gap:4px}
    .modal-box select,.modal-box input{padding:6px;border:1px solid #ccc;border-radius:4px}
    .modal-actions{display:flex;gap:10px;justify-content:center;margin-top:6px}
    .close-btn{background:#dc3545}
  </style>
</head>
<body>
<div class="container">
  <h1>–î–∞—à–±–æ—Ä–¥ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</h1>

  <!-- ====== –ö–ù–û–ü–ö–ê –ì–õ–ê–í–ù–ê–Ø ====== -->
  <div class="top-nav">
    <button class="btn home-btn" onclick="location.href='/'">üè†¬†–ì–ª–∞–≤–Ω–∞—è</button>
  </div>

  <!-- ====== –ü–ê–ù–ï–õ–¨ –§–ò–õ–¨–¢–†–û–í ====== -->
  <div class="filter-panel">
    <div class="filter-fields">
      <label>–î–∞—Ç–∞ –æ—Ç <input type="date" id="f-start"></label>
      <label>–î–∞—Ç–∞ –¥–æ <input type="date" id="f-end"></label>
      <label>–°—Ç–∞—Ç—É—Å
        <select id="f-status"><option value="">–í—Å–µ</option><option>–ù–æ–≤–∞—è</option><option>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–∞—è</option>
          <option>–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option><option>–û—Ç–º–µ–Ω–µ–Ω–∞</option><option>–ü–ª–∞—Ç–µ–∂ –≤—ã–ø–æ–ª–Ω–µ–Ω</option>
          <option>–ü–ª–∞—Ç–µ–∂ —É–¥–∞–ª–µ–Ω</option><option>–í–æ–∑–≤—Ä–∞—Ç</option></select></label>
      <label>–¢–∏–ø
        <select id="f-type"><option value="">–í—Å–µ</option><option>–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ</option><option>–°–ø–∏—Å–∞–Ω–∏–µ</option></select></label>
      <label>–ú–∏–Ω.¬†—Å—É–º–º–∞ <input type="number" step="0.01" id="f-min" placeholder="0"></label>
      <label>–ú–∞–∫—Å.¬†—Å—É–º–º–∞ <input type="number" step="0.01" id="f-max" placeholder="0"></label>
      <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è <input type="text" id="f-cat" placeholder="–õ—é–±–∞—è"></label>
      <label>–ë–∞–Ω–∫ –æ—Ç–ø. <input type="text" id="f-sbank" placeholder="–õ—é–±–æ–π"></label>
      <label>–ë–∞–Ω–∫ –ø–æ–ª—É—á. <input type="text" id="f-rbank" placeholder="–õ—é–±–æ–π"></label>
      <label>–ò–ù–ù –ø–æ–ª—É—á. <input type="text" id="f-inn" pattern="\d{10,11}" placeholder="10‚Äë11¬†—Ü–∏—Ñ—Ä"></label>
    </div>
    <div class="filter-buttons">
      <button class="btn apply-btn"  id="btn-apply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <button class="btn clear-btn"  id="btn-clear">–°–±—Ä–æ—Å–∏—Ç—å</button>
      <button class="btn report-btn" id="btn-report">–°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç</button>
    </div>
  </div>

  <!-- ====== –ß–ê–†–¢–´ ====== -->
  <div class="charts">
    <div class="chart-container"><h3>–ï–∂–µ–º–µ—Å—è—á–Ω–æ–µ&nbsp;–∫–æ–ª‚Äë–≤–æ</h3><canvas id="c-month"></canvas></div>
    <div class="chart-container"><h3>–ü–æ&nbsp;—Ç–∏–ø—É</h3><canvas id="c-type"></canvas></div>
    <div class="chart-container"><h3>–î–æ—Ö–æ–¥—ã¬†vs¬†–†–∞—Å—Ö–æ–¥—ã</h3><canvas id="c-sum"></canvas></div>
    <div class="chart-container"><h3>–ü–æ&nbsp;—Å—Ç–∞—Ç—É—Å–∞–º</h3><canvas id="c-status"></canvas></div>
    <div class="chart-container"><h3>–ë–∞–Ω–∫–∏&nbsp;–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è</h3><canvas id="c-sender"></canvas></div>
    <div class="chart-container"><h3>–ë–∞–Ω–∫–∏&nbsp;–ø–æ–ª—É—á–∞—Ç–µ–ª—è</h3><canvas id="c-recipient"></canvas></div>
    <div class="chart-container"><h3>–ü–æ&nbsp;–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3><canvas id="c-cat"></canvas></div>
  </div>
</div>

<!-- ====== –ú–û–î–ê–õ–ö–ê –û–¢–ß–Å–¢–ê ====== -->
<div class="modal" id="report-modal">
  <div class="modal-box">
    <h2>–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç</h2>
    <label>–î–∞—Ç–∞ –æ—Ç <input type="date" id="r-start"></label>
    <label>–î–∞—Ç–∞ –¥–æ <input type="date" id="r-end"></label>
    <label>–§–æ—Ä–º–∞—Ç
      <select id="r-format"><option value="pdf">PDF</option><option value="xlsx">Excel</option></select>
    </label>
    <div class="modal-actions">
      <button class="btn apply-btn" id="r-download">–°–∫–∞—á–∞—Ç—å</button>
      <button class="btn close-btn" id="r-close">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<script>
/* ---------- Chart.js –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ---------- */
Chart.defaults.font.family = 'Arial, Helvetica, sans-serif';
Chart.defaults.plugins.legend.position = 'bottom';
Chart.defaults.plugins.legend.labels.usePointStyle = true;
const COLORS = ['#4e79a7','#f28e2c','#e15759','#76b7b2','#59a14f','#edc948','#b07aa1','#ff9da7'];

const API    = 'http://127.0.0.1:8000';
const token  = localStorage.getItem('access_token');
if (!token) location = '/auth';

/* ---------- —Å—Å—ã–ª–∫–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∏ ---------- */
let gMonth,gType,gSum,gStatus,gSender,gRecipient,gCat;

/* ---------- –ö–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞ –∏ –æ—Ç—á—ë—Ç–∞ ---------- */
document.getElementById('btn-apply').onclick  = loadAll;
document.getElementById('btn-clear').onclick  = ()=>{document.querySelectorAll('.filter-fields input,.filter-fields select').forEach(el=>el.value='');loadAll();};
document.getElementById('btn-report').onclick = ()=> document.getElementById('report-modal').classList.add('active');
document.getElementById('r-close').onclick    = ()=> document.getElementById('report-modal').classList.remove('active');
document.getElementById('r-download').onclick = downloadReport;

/* ---------- —É—Ç–∏–ª–∏—Ç—ã ---------- */
function qs(id){return document.getElementById(id).value;}
function buildChart(old,ctx,cfg){ if(old) old.destroy(); return new Chart(ctx,cfg); }
function barCfg(labels,data,label){return{type:'bar',data:{labels,datasets:[{label,data,backgroundColor:COLORS}]},
  options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}};}
function doughnutCfg(labels,data){return{type:'doughnut',data:{labels,datasets:[{data,backgroundColor:COLORS,borderColor:'#fff',borderWidth:2}]},
  options:{responsive:true,maintainAspectRatio:false,cutout:'42%'}};}

/* ---------- –æ—Å–Ω–æ–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ ---------- */
async function loadAll(){
  const p = new URLSearchParams();
  const map = {'start_date':'f-start','end_date':'f-end','status':'f-status','transaction_type':'f-type',
               'min_amount':'f-min','max_amount':'f-max','category':'f-cat',
               'sender_bank':'f-sbank','recipient_bank':'f-rbank','recipient_inn':'f-inn'};
  for(const [key,id] of Object.entries(map)){ const val = qs(id); if(val) p.set(key,val); }

  /* —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
  const st = await fetch(`${API}/transactions/stats?${p}`,{headers:{Authorization:`Bearer ${token}`}}).then(r=>r.json());

  gMonth     = buildChart(gMonth,document.getElementById('c-month'),
                barCfg(st.monthly.map(d=>new Date(d.period).toLocaleString('ru',{month:'short',year:'numeric'})),
                       st.monthly.map(d=>d.count),'–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏'));

  gType      = buildChart(gType,document.getElementById('c-type'),
                doughnutCfg(st.by_type.map(d=>d.type),st.by_type.map(d=>d.count)));

  gSum       = buildChart(gSum,document.getElementById('c-sum'),
                barCfg(['–î–æ—Ö–æ–¥—ã','–†–∞—Å—Ö–æ–¥—ã'],[st.sums.income,st.sums.expense],'‚ÇΩ'));

  gStatus    = buildChart(gStatus,document.getElementById('c-status'),
                doughnutCfg(st.by_status.map(d=>d.status),st.by_status.map(d=>d.count)));

  gSender    = buildChart(gSender,document.getElementById('c-sender'),
                barCfg(st.by_sender_bank.map(d=>d.bank||'‚Äî'),st.by_sender_bank.map(d=>d.count),'–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏'));

  gRecipient = buildChart(gRecipient,document.getElementById('c-recipient'),
                barCfg(st.by_recipient_bank.map(d=>d.bank||'‚Äî'),st.by_recipient_bank.map(d=>d.count),'–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏'));

  /* –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äì –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å */
  const list = await fetch(`${API}/transactions/?${p}`,{headers:{Authorization:`Bearer ${token}`}}).then(r=>r.json());
  const cats={}; list.forEach(t=>{const c=t.category||'–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'; cats[c]=(cats[c]||0)+1;});
  gCat = buildChart(gCat,document.getElementById('c-cat'),doughnutCfg(Object.keys(cats),Object.values(cats)));
}

/* ---------- —Å–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç ---------- */
async function downloadReport(){
  const modal = document.getElementById('report-modal');
  const params = new URLSearchParams();

  /* —Å–æ–±–∏—Ä–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ –ø–∞–Ω–µ–ª–∏ */
  const filterIds = {'start_date':'f-start','end_date':'f-end','status':'f-status','transaction_type':'f-type',
                     'min_amount':'f-min','max_amount':'f-max','category':'f-cat',
                     'sender_bank':'f-sbank','recipient_bank':'f-rbank','recipient_inn':'f-inn'};
  for(const [k,id] of Object.entries(filterIds)){ const v=qs(id); if(v) params.set(k,v); }

  /* + –¥–∞—Ç–∞/—Ñ–æ—Ä–º–∞—Ç –∏–∑ –º–æ–¥–∞–ª–∫–∏ */
  if(qs('r-start')) params.set('start_date',qs('r-start'));
  if(qs('r-end'))   params.set('end_date',qs('r-end'));
  params.set('format',qs('r-format'));

  const res = await fetch(`${API}/reports?${params}`,{headers:{Authorization:`Bearer ${token}`}});

  if(!res.ok){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç'); return; }

  const blob = await res.blob();
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url;
  a.download = `report.${params.get('format')==='xlsx'?'xlsx':'pdf'}`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  modal.classList.remove('active');
}

/* ---------- —Å—Ç–∞—Ä—Ç ---------- */
loadAll();
</script>
</body>
</html>
