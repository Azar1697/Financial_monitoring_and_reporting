<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–∞—à–±–æ—Ä–¥</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f5f7fa;
    }
    .container {
      max-width: 900px;
      margin: auto;
    }
    h1 {
      margin-bottom: 10px;
    }
    .stats {
      display: flex;
      gap: 20px;
      margin: 20px 0;
    }
    .stat {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      text-align: center;
    }
    .nav {
      margin: 30px 0;
      text-align: center;
    }
    .nav button {
      padding: 10px 20px;
      margin: 5px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #logout {
      float: right;
      background: crimson;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ <button id="logout">–í—ã–π—Ç–∏</button></h1>
    <p id="welcome-message">–ü—Ä–∏–≤–µ—Ç, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</p>

    <div class="stats">
      <div class="stat">
        <h3>–î–æ—Ö–æ–¥—ã</h3>
        <p id="income-total">‚Äî</p>
      </div>
      <div class="stat">
        <h3>–†–∞—Å—Ö–æ–¥—ã</h3>
        <p id="expense-total">‚Äî</p>
      </div>
      <div class="stat">
        <h3>–í—Å–µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h3>
        <p id="transaction-count">‚Äî</p>
      </div>
    </div>

    <canvas id="transactionChart" height="120"></canvas>

    <div class="nav">
      <button onclick="location.href='/transactions'">–í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</button>
      <button onclick="location.href='/add_transaction'">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>

  <script>
    const API_URL = "http://127.0.0.1:8000";
    const token = localStorage.getItem("access_token");

    console.log("üîë –¢–æ–∫–µ–Ω –∏–∑ localStorage:", token);

    if (!token) {
      console.warn("‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ ‚Äî —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /auth");
      window.location.href = "/auth";
    }

    document.getElementById("logout").addEventListener("click", () => {
      localStorage.removeItem("access_token");
      window.location.href = "/auth";
    });

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
    fetch(`${API_URL}/profile`, {
      headers: {
        Authorization: `Bearer ${token}`
      }
    })
    .then(res => {
      if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏");
      return res.json();
    })
    .then(data => {
      console.log("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:", data);
      document.getElementById("welcome-message").textContent = `–ü—Ä–∏–≤–µ—Ç, ${data.email}`;
    })
    .catch(err => {
      console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è:", err);
      localStorage.removeItem("access_token");
      window.location.href = "/auth";
    });

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    fetch(`${API_URL}/transactions`, {
      headers: {
        Authorization: `Bearer ${token}`
      }
    })
    .then(res => {
      if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π");
      return res.json();
    })
    .then(data => {
      let income = 0, expense = 0;
      const monthly = {};

      data.forEach(tx => {
        const month = new Date(tx.date_time).toLocaleString("ru", { month: "short" });
        if (!monthly[month]) monthly[month] = { income: 0, expense: 0 };

        if (tx.transaction_type === "–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ") {
          income += tx.amount;
          monthly[month].income += tx.amount;
        } else {
          expense += tx.amount;
          monthly[month].expense += tx.amount;
        }
      });

      document.getElementById("income-total").textContent = `${income.toFixed(2)} ‚ÇΩ`;
      document.getElementById("expense-total").textContent = `${expense.toFixed(2)} ‚ÇΩ`;
      document.getElementById("transaction-count").textContent = data.length;

      const labels = Object.keys(monthly);
      const incomeData = labels.map(m => monthly[m].income);
      const expenseData = labels.map(m => monthly[m].expense);

      new Chart(document.getElementById("transactionChart"), {
        type: "bar",
        data: {
          labels: labels,
          datasets: [
            {
              label: "–î–æ—Ö–æ–¥—ã",
              data: incomeData,
              backgroundColor: "rgba(75, 192, 192, 0.6)"
            },
            {
              label: "–†–∞—Å—Ö–æ–¥—ã",
              data: expenseData,
              backgroundColor: "rgba(255, 99, 132, 0.6)"
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    })
    .catch(err => {
      console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:", err);
    });
  </script>
</body>
</html>

