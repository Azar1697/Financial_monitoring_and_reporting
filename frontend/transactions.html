<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–æ–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
    }
    h1 {
      text-align: center;
    }
    .top-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
    }
    .top-buttons button {
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      border-radius: 6px;
      font-size: 14px;
      font-weight: bold;
    }
    .home-btn { background-color: #007bff; color: white; }
    .add-btn  { background-color: #28a745; color: white; }

    .filter-panel {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .filter-panel h2 {
      margin-top: 0;
      font-size: 18px;
      text-align: center;
    }
    .filter-fields {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: space-between;
    }
    .filter-fields label {
      display: flex;
      flex-direction: column;
      flex: 1 1 150px;
      font-size: 14px;
    }
    .filter-fields input,
    .filter-fields select {
      padding: 6px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .filter-buttons {
      text-align: center;
      margin-top: 10px;
    }
    .filter-buttons button {
      padding: 6px 14px;
      margin: 0 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }
    .apply-btn { background: #007bff; color: white; }
    .clear-btn { background: #6c757d; color: white; }

    table {
      border-collapse: collapse;
      width: 100%;
      background-color: #fff;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
      font-size: 14px;
    }
    th {
      background-color: #eee;
    }
    .edit-btn {
      background-color: #ffc107;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 4px;
    }
    .delete-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>–ú–æ–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h1>

  <div class="top-buttons">
    <button class="home-btn" onclick="window.location.href='/'">üè† –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</button>
    <button class="add-btn"  onclick="window.location.href='/add_transaction'">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</button>
  </div>

  <div class="filter-panel">
    <h2>–§–∏–ª—å—Ç—Ä—ã</h2>
    <div class="filter-fields">
      <label>
        –î–∞—Ç–∞ –æ—Ç
        <input type="date" id="filter-start-date">
      </label>
      <label>
        –î–∞—Ç–∞ –¥–æ
        <input type="date" id="filter-end-date">
      </label>
      <label>
        –°—Ç–∞—Ç—É—Å
        <select id="filter-status">
          <option value="">–í—Å–µ</option>
          <option>–ù–æ–≤–∞—è</option>
          <option>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–∞—è</option>
          <option>–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
          <option>–û—Ç–º–µ–Ω–µ–Ω–∞</option>
          <option>–ü–ª–∞—Ç–µ–∂ –≤—ã–ø–æ–ª–Ω–µ–Ω</option>
          <option>–ü–ª–∞—Ç–µ–∂ —É–¥–∞–ª–µ–Ω</option>
          <option>–í–æ–∑–≤—Ä–∞—Ç</option>
        </select>
      </label>
      <label>
        –¢–∏–ø
        <select id="filter-type">
          <option value="">–í—Å–µ</option>
          <option>–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ</option>
          <option>–°–ø–∏—Å–∞–Ω–∏–µ</option>
        </select>
      </label>
      <label>
        –ú–∏–Ω. —Å—É–º–º–∞
        <input type="number" step="0.01" id="filter-min-amount" placeholder="0">
      </label>
      <label>
        –ú–∞–∫—Å. —Å—É–º–º–∞
        <input type="number" step="0.01" id="filter-max-amount" placeholder="0">
      </label>
      <label>
        –ö–∞—Ç–µ–≥–æ—Ä–∏—è
        <input type="text" id="filter-category" placeholder="–¢–µ–∫—Å—Ç">
      </label>
      <label>
        –ë–∞–Ω–∫ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
        <input type="text" id="filter-sender-bank" placeholder="–¢–µ–∫—Å—Ç">
      </label>
      <label>
        –ë–∞–Ω–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
        <input type="text" id="filter-recipient-bank" placeholder="–¢–µ–∫—Å—Ç">
      </label>
      <label>
        –ò–ù–ù –ø–æ–ª—É—á–∞—Ç–µ–ª—è
        <input type="text" id="filter-recipient-inn" pattern="\d{10,11}" placeholder="10‚Äì11 —Ü–∏—Ñ—Ä">
      </label>
    </div>
    <div class="filter-buttons">
      <button class="apply-btn" id="apply-filters">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <button class="clear-btn" id="clear-filters">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>
  </div>

  <table id="transactions-table">
    <thead>
      <tr>
        <th>‚Ññ</th>
        <th>–¢–∏–ø</th>
        <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
        <th>–°—É–º–º–∞</th>
        <th>–î–∞—Ç–∞</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API_URL = 'http://127.0.0.1:8000';
    const token = localStorage.getItem('access_token');
    if (!token) location.href = '/auth';

    // –ø—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–æ–∫
    document.getElementById('apply-filters').onclick = () => fetchTransactions();
    document.getElementById('clear-filters').onclick = () => {
      document.querySelectorAll('.filter-fields input, .filter-fields select')
        .forEach(el => el.value = '');
      fetchTransactions();
    };

    async function fetchTransactions() {
      const url = new URL('/transactions/', API_URL);
      const params = url.searchParams;

      const startDate = document.getElementById('filter-start-date').value;
      const endDate   = document.getElementById('filter-end-date').value;
      const status    = document.getElementById('filter-status').value;
      const type      = document.getElementById('filter-type').value;
      const minAmt    = document.getElementById('filter-min-amount').value;
      const maxAmt    = document.getElementById('filter-max-amount').value;
      const category  = document.getElementById('filter-category').value;
      const sbank     = document.getElementById('filter-sender-bank').value;
      const rbank     = document.getElementById('filter-recipient-bank').value;
      const inn       = document.getElementById('filter-recipient-inn').value;

      if (startDate) params.set('start_date', startDate);
      if (endDate)   params.set('end_date',   endDate);
      if (status)    params.set('status',     status);
      if (type)      params.set('type',       type);
      if (minAmt)    params.set('min_amount', minAmt);
      if (maxAmt)    params.set('max_amount', maxAmt);
      if (category)  params.set('category',   category);
      if (sbank)     params.set('sender_bank', sbank);
      if (rbank)     params.set('recipient_bank', rbank);
      if (inn)       params.set('recipient_inn', inn);

      const res = await fetch(url.toString(), {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!res.ok) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:', res.status);
        return;
      }
      const data = await res.json();
      renderTable(data);
    }

    function renderTable(data) {
      const tbody = document.querySelector('#transactions-table tbody');
      tbody.innerHTML = '';
      data.forEach((tx, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${tx.transaction_type}</td>
          <td>${tx.category || '-'}</td>
          <td>${tx.amount}</td>
          <td>${new Date(tx.date_time).toLocaleString()}</td>
          <td>${tx.status}</td>
          <td>
            <button class="edit-btn" onclick="window.location.href='/edit_transaction/${tx.id}'">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="delete-btn" onclick="deleteTransaction(${tx.id})">–£–¥–∞–ª–∏—Ç—å</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function deleteTransaction(id) {
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é ‚Ññ${id}?`)) return;
      const res = await fetch(`${API_URL}/transactions/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (res.ok) fetchTransactions();
      else alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
    }

    // –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    fetchTransactions();
  </script>
</body>
</html>